<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UNiV & KazumiLocks Project</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #sidebar { width: 200px; background: #111; color: white; padding: 10px; border-right: 2px solid black; overflow-y: auto; }
    #content { flex: 1; padding: 20px; overflow-y: auto; background: white; color: black; border-left: 2px solid black; }
    .page { cursor: pointer; padding: 5px; border-radius: 5px; color: white; display: flex; justify-content: space-between; align-items: center; }
    .page:hover { background: #333; }
    .page.active { background: black; font-weight: bold; }
    .delete-btn { margin-left: 8px; color: white; cursor: pointer; font-weight: bold; }
    .delete-btn:hover { color: red; }
    .block { margin: 5px 0; padding: 4px; border-radius: 4px; border-bottom: 1px solid black; color: black; }
    .block[contenteditable="true"]:focus { outline: 2px solid #007bff; background: #f0f0f0; }
    h1#mainTitle { color: white; background: black; padding: 10px; text-align: center; margin: 0; font-size: 28px; font-weight: bold; }
    h2#pageTitle { border-bottom: 2px solid black; padding-bottom: 4px; color: black; font-weight: bold; }
    button { margin: 5px 0; background: black; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #333; }
    #loginBtn, #logoutBtn { margin-top: 10px; width: 100%; }
    #accountLogo { width: 32px; height: 32px; border-radius: 50%; margin-top: 10px; display: none; }

    #popupOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 999; }
    #popup { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    #popup button { margin: 10px; }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <div id="sidebar">
    <h3>Pages</h3>
    <div id="authSection">
      <button id="loginBtn">Login with Google</button>
      <button id="logoutBtn" style="display:none">Logout</button>
      <img id="accountLogo" />
    </div>
    <hr>
    <div id="pages"></div>
    <button onclick="newPage()">+ Page</button>
    <hr>
    <button onclick="exportData()">Export</button>
    <input type="file" id="importFile" onchange="importData(event)" />
  </div>
  <div id="content">
    <h1 id="mainTitle">UNiV & KazumiLocks Project</h1>
    <h2 id="pageTitle" contenteditable="true" oninput="updateTitle()">Untitled</h2>
    <div id="blocks"></div>
    <button onclick="newBlock()">+ Block</button>
  </div>

  <div id="popupOverlay">
    <div id="popup">
      <p>Are you sure you want to delete this page?</p>
      <button onclick="confirmDelete(true)">Yes</button>
      <button onclick="confirmDelete(false)">No</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCXTHtDhmwvmQ5Znr0jVaZf0jlVP0uvDs",
      authDomain: "project-222171401581.firebaseapp.com",
      databaseURL: "https://univ-809cb-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "project-222171401581",
      storageBucket: "project-222171401581.appspot.com",
      messagingSenderId: "222171401581",
      appId: "1:222171401581:web:8db17bf2ab448b09265e64"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const accountLogo = document.getElementById("accountLogo");

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(console.error);
    };

    logoutBtn.onclick = () => { auth.signOut(); };

    auth.onAuthStateChanged(user => {
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
        accountLogo.src = user.photoURL;
        accountLogo.style.display = "block";
        currentUserId = user.uid;
        loadUserData(user.uid);
      } else {
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        accountLogo.style.display = "none";
        currentUserId = null;
        data = {};
        currentPage = null;
        renderPages();
        renderPage();
      }
    });
  </script>

  <script>
    let data = {};
    let currentPage = null;
    let pendingDeleteId = null;
    let currentUserId = null;

    function save(){
      if(currentUserId){
        database.ref('users/' + currentUserId + '/pages').set(data);
      }
      localStorage.setItem('notey-data-'+(currentUserId||'guest'), JSON.stringify(data));
    }

    function loadUserData(uid){
      currentUserId = uid;
      const localData = localStorage.getItem('notey-data-'+uid);
      if(localData){ data = JSON.parse(localData); }
      database.ref('users/' + uid + '/pages').once('value').then(snapshot => {
        if(snapshot.exists()){ data = snapshot.val(); }
        currentPage = Object.keys(data)[0] || null;
        renderPages();
        renderPage();
      }).catch(() => {
        currentPage = Object.keys(data)[0] || null;
        renderPages();
        renderPage();
      });
    }

    function renderPages(){
      const pagesDiv = document.getElementById('pages');
      pagesDiv.innerHTML='';
      Object.keys(data).forEach(id=>{
        const div=document.createElement('div');
        div.className='page'+(id===currentPage?' active':'');
        div.onclick=()=>openPage(id);

        const span=document.createElement('span');
        span.textContent=data[id].title;

        const del=document.createElement('span');
        del.textContent='X';
        del.className='delete-btn';
        del.onclick=(e)=>{ e.stopPropagation(); showPopup(id); };

        div.appendChild(span);
        div.appendChild(del);
        pagesDiv.appendChild(div);
      });
    }

    function newPage(){
      const id=Date.now().toString();
      data[id]={title:'Untitled',blocks:[]};
      currentPage=id; save(); renderPages(); renderPage();
    }

    function openPage(id){ currentPage=id; save(); renderPages(); renderPage(); }
    function renderPage(){
      if(!currentPage) return;
      const page=data[currentPage];
      document.getElementById('pageTitle').textContent=page.title;
      const blocksDiv=document.getElementById('blocks');
      blocksDiv.innerHTML='';
      page.blocks.forEach(b=>{
        const div=document.createElement('div');
        div.className='block';
        div.contentEditable=true;
        div.innerHTML=b.text;
        div.oninput=()=>{ b.text=div.innerHTML; save(); };
        div.addEventListener("keydown", e => {
          if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); document.execCommand("insertParagraph"); }
        });
        blocksDiv.appendChild(div);
      });
    }

    function newBlock(){ if(!currentPage) return; data[currentPage].blocks.push({text:''}); save(); renderPage(); }
    function updateTitle(){ if(!currentPage) return; data[currentPage].title=document.getElementById('pageTitle').textContent; save(); renderPages(); }
    function deletePage(id){ delete data[id]; if(currentPage===id) currentPage=null; save(); renderPages(); renderPage(); }
    function showPopup(id){ pendingDeleteId=id; document.getElementById('popupOverlay').style.display='flex'; }
    function confirmDelete(yes){ document.getElementById('popupOverlay').style.display='none'; if(yes && pendingDeleteId) deletePage(pendingDeleteId); pendingDeleteId=null; }
    function exportData(){ const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='notey-export.json'; a.click(); }
    function importData(event){ const file=event.target.files[0]; const reader=new FileReader(); reader.onload=e=>{ data=JSON.parse(e.target.result); save(); renderPages(); }; reader.readAsText(file); }
  </script>
</body>
</html>
